name: AIN-10 • long charts & intraday percent

on:
  workflow_dispatch:
  schedule:
    # 平日 09:00–17:30 JST の間、10分おき
    # (= 00:00–08:30 UTC)。必要に応じて調整してください。
    - cron: "*/10 0-8 * * 1-5"

permissions:
  contents: write

concurrency:
  group: ain10-long
  cancel-in-progress: false

env:
  INDEX_KEY: ain10
  OUT_DIR: docs/outputs

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # 依存関係確認（デバッグ用）
          python - <<'PY'
          import sys, matplotlib
          print("Py:", sys.version)
          print("Matplotlib:", matplotlib.__version__)
          PY

      # ──────────────────────────────────────────────────────────────
      # 長期チャートの生成（1d/7d/1m/1y）
      # ※ scripts/long_charts.py はリポジトリ同梱の前提
      # ──────────────────────────────────────────────────────────────
      - name: Generate long-term charts
        run: |
          set -euxo pipefail
          python scripts/long_charts.py

      # ──────────────────────────────────────────────────────────────
      # 1d 騰落率を算出し、テキスト/JSON を出力
      #   ・分母は「10:00 以降の最初の非ゼロ」を既定（stable@10:00）
      #   ・小さすぎる分母は N/A（basis=no_pct_col）
      # ──────────────────────────────────────────────────────────────
      - name: Compute 1d percent & write posts
        run: |
          set -euxo pipefail
          python scripts/ain10_pct_post.py \
            --index-key "${INDEX_KEY}" \
            --csv "${OUT_DIR}/${INDEX_KEY}_1d.csv" \
            --out-json "${OUT_DIR}/${INDEX_KEY}_stats.json" \
            --out-text "${OUT_DIR}/${INDEX_KEY}_post_intraday.txt" \
            --basis stable@10:00

      # デバッグ用に生成物をアップロード（任意）
      - name: Upload artifacts (for debug)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ain10-outputs
          path: |
            docs/outputs/*.csv
            docs/outputs/*.png
            docs/outputs/*post*.txt
            docs/outputs/*stats*.json

      # 変更があればコミット
      - name: Commit charts if changed
        run: |
          set -euxo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A docs/outputs
          if ! git diff --cached --quiet; then
            git commit -m "chore(charts): update ${INDEX_KEY} (1d/7d/1m/1y + stats + intraday)"
            git push
          else
            echo "No changes to commit."
          fi
